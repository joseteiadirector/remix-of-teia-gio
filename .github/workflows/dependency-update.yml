name: Dependency Updates

on:
  schedule:
    - cron: '0 0 * * 1' # Toda segunda-feira Ã s 00:00
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Check for outdated packages
      run: |
        echo "ðŸ“¦ Verificando pacotes desatualizados..."
        npm outdated || true
        
    - name: Security audit
      run: |
        echo "ðŸ”’ Auditoria de seguranÃ§a..."
        npm audit --audit-level=moderate || true
        
    - name: Create issue for updates
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { execSync } = require('child_process');
          
          let outdated = '';
          try {
            outdated = execSync('npm outdated --json').toString();
          } catch (error) {
            outdated = error.stdout.toString();
          }
          
          if (outdated) {
            const packages = JSON.parse(outdated || '{}');
            const packageList = Object.entries(packages)
              .map(([name, info]) => `- **${name}**: ${info.current} â†’ ${info.latest}`)
              .join('\n');
            
            const body = `## ðŸ“¦ Dependency Update Report
            
            Foram encontrados pacotes desatualizados:
            
            ${packageList}
            
            ### RecomendaÃ§Ãµes
            - Revisar changelog de cada pacote
            - Testar atualizaÃ§Ãµes em ambiente de desenvolvimento
            - Atualizar pacotes de seguranÃ§a primeiro
            
            ---
            *Automated weekly dependency check*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“¦ Weekly Dependency Update Report',
              body: body,
              labels: ['dependencies', 'maintenance']
            });
          }
